<div class="memos-wrapper">
    <div class="memos-editor">
        <textarea id="memo-content" placeholder="è®°å½•ä¸‹æƒ³æ³•...ğŸ’¡"></textarea>
        <div class="editor-footer">
            <input type="password" id="memo-pass" placeholder="è¾“å…¥å¯†ç " class="pass-input">
            <button onclick="verifyAdmin()" id="auth-btn" title="éªŒè¯èº«ä»½">ğŸ”‘</button>
            <button onclick="postMemo()" id="post-btn">å‘é€ğŸš€</button>
        </div>
    </div>

    <div id="memos-list">
        <div class="loading"> LoadingğŸ“¡</div>
    </div>

    <button onclick="loadMemos()" id="load-more-btn" style="display:none">åŠ è½½æ›´å¤š</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<script src="//cdn.jsdelivr.net/npm/xss@1.0.14/dist/xss.min.js"></script>
<script>
    // ================= é…ç½®åŒº =================
    const APP_ID = '7DskOMG6exb3QzJdatkZVLvj-MdYXbMMI';
    const APP_KEY = 'Kgaf0mnSA2nlYMoZgkLfEzQn';
    const ADMIN_HASH = '50d1587ff34a6910c8e76b899d69eae2';
    const ADMIN_ROLE = 'admin';
    // =========================================

    const { Query, User, Role } = AV;
    AV.init({
        appId: APP_ID, appKey: APP_KEY,
        serverURLs: "https://api.youngreviews.cc"
    });

    let page = 0;
    const pageSize = 5;
    let isAdmin = localStorage.getItem('memo_admin_md5') === ADMIN_HASH;

    // åˆå§‹åŒ–ç®¡ç†å‘˜è§’è‰²ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    async function initAdminRole() {
        try {
            const adminRoleQuery = new AV.Query(Role);
            const role = await adminRoleQuery.equalTo('name', ADMIN_ROLE).first();

            if (!role) {
                // è§’è‰²ä¸å­˜åœ¨ï¼Œåˆ›å»ºç®¡ç†å‘˜è§’è‰²
                const adminRole = new Role();
                adminRole.setName(ADMIN_ROLE);
                adminRole.setACL(new AV.ACL());
                await adminRole.save();
                console.log('ç®¡ç†å‘˜è§’è‰²åˆ›å»ºæˆåŠŸ');
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–è§’è‰²å¤±è´¥:', error);
        }
    }

    async function loadMemos() {
        const query = new AV.Query('shuoshuo');
        query.descending('createdAt');
        query.limit(pageSize);
        query.skip(page * pageSize);

        try {
            const results = await query.find();
            const listDiv = document.getElementById('memos-list');
            const loadBtn = document.getElementById('load-more-btn');

            if (page === 0) listDiv.innerHTML = '';

            if (results.length === 0) {
                loadBtn.style.display = 'none';
                if (page === 0) listDiv.innerHTML = '<div class="empty">æš‚æ— å†…å®¹</div>';
                return;
            }

            results.forEach(memo => {
                const content = filterXSS(memo.get('content'));
                const dateObj = memo.createdAt;
                const dateStr = `${dateObj.getFullYear()}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')} ${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                const objectId = memo.id;

                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰åˆ é™¤æƒé™
                const canDelete = isAdmin || memo.getACL().getWriteAccess(User.current());

                const delBtnHtml = isAdmin ? `<span class="del-btn" onclick="deleteMemo('${objectId}', this)">åˆ é™¤</span>` : '';

                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <div class="memo-avatar"></div>
                    <div class="memo-content">
                        <div class="memo-text">${content}</div>
                        <div class="memo-meta">
                            <span class="memo-date">${dateStr}</span>
                            ${delBtnHtml}
                        </div>
                    </div>
                `;
                listDiv.appendChild(item);
            });

            page++;
            loadBtn.style.display = 'block';
        } catch (error) {
            console.error(error);
            alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        }
    }

    function verifyAdmin() {
        const inputPass = document.getElementById('memo-pass').value;

        if (md5(inputPass) === ADMIN_HASH) {
            localStorage.setItem('memo_admin_md5', ADMIN_HASH);
            isAdmin = true;
            alert('èº«ä»½éªŒè¯æˆåŠŸï¼ğŸ”“');
            page = 0;
            loadMemos();
            document.getElementById('memo-pass').value = '';
        } else {
            alert('éªŒè¯å¤±è´¥ğŸš«');
        }
    }

    async function postMemo() {
        const content = document.getElementById('memo-content').value;
        const inputPass = document.getElementById('memo-pass').value;

        if (!content) return alert('å†™ç‚¹ä»€ä¹ˆå§ï¼Ÿ');
        if (!isAdmin && md5(inputPass) !== ADMIN_HASH) return alert('è¯·è¾“å…¥æ­£ç¡®å¯†ç ');

        const btn = document.getElementById('post-btn');
        btn.innerText = 'å‘é€ä¸­...';
        btn.disabled = true;

        try {
            // ç¡®ä¿ç®¡ç†å‘˜è§’è‰²å­˜åœ¨
            await initAdminRole();

            const Memo = AV.Object.extend('shuoshuo');
            const memo = new Memo();
            memo.set('content', content);

            // åˆ›å»º ACLï¼šå…¬å…±è¯»ï¼Œåªæœ‰ç®¡ç†å‘˜è§’è‰²å†™
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setRoleWriteAccess(ADMIN_ROLE, true);

            memo.setACL(acl);
            await memo.save();

            alert('å‘å¸ƒæˆåŠŸï¼âœ…');
            document.getElementById('memo-content').value = '';
            page = 0;
            loadMemos();

        } catch (error) {
            console.error(error);
            alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message);
        }

        btn.innerText = 'å‘é€ğŸš€';
        btn.disabled = false;
    }

    async function deleteMemo(objectId, btnElement) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯´è¯´å—ï¼Ÿ')) return;

        // åˆ é™¤ä¹Ÿéœ€è¦éªŒè¯å¯†ç 
        const inputPass = document.getElementById('memo-pass').value;
        if (!isAdmin && md5(inputPass) !== ADMIN_HASH) {
            return alert('è¯·è¾“å…¥æ­£ç¡®å¯†ç æ‰èƒ½åˆ é™¤');
        }

        try {
            const query = new AV.Query('shuoshuo');
            const memo = await query.get(objectId);

            // å°è¯•è·å–å¯¹è±¡çš„ ACL
            const acl = memo.getACL();
            console.log('å¯¹è±¡ ACL:', acl);

            // ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¼ºåˆ¶åˆ é™¤
            const adminRole = await new AV.Query(Role).equalTo('name', ADMIN_ROLE).first();
            if (adminRole) {
                // ä¸´æ—¶ä¿®æ”¹ ACL å…è®¸åˆ é™¤
                const tempAcl = new AV.ACL();
                tempAcl.setPublicReadAccess(true);
                tempAcl.setRoleWriteAccess(ADMIN_ROLE, true);
                memo.setACL(tempAcl);
                await memo.save();

                // ç°åœ¨å¯ä»¥åˆ é™¤äº†
                await memo.destroy();

                const item = btnElement.closest('.memo-item');
                item.remove();
                alert('åˆ é™¤æˆåŠŸï¼ğŸ—‘ï¸');
            } else {
                alert('æ— æ³•åˆ é™¤ï¼šç®¡ç†å‘˜è§’è‰²ä¸å­˜åœ¨');
            }
        } catch (error) {
            console.error('åˆ é™¤é”™è¯¯è¯¦æƒ…:', error);
            alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
    }

    loadMemos();
</script>
